{% extends 'base/base.html' %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm border-light" style="transition: none; transform: none;">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Checkout</h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="contact" class="form-label">Contact Number:</label>
                            <input type="tel" id="contact" name="contact_number" class="form-control" placeholder="0123456789" pattern="[0-9]*" inputmode="numeric" required>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Shipping Address:</label>
                            <input type="text" id="address" name="shipping_address" class="form-control" placeholder="Select an address" required>
                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">
                        </div>

                        <div id="map" style="height: 300px; width: 100%;" class="mb-4"></div>
                        
                        <fieldset class="mb-4">
                            <legend class="form-label">Payment Method:</legend>
                            <div class="form-check">
                                <input type="radio" name="payment_method" value="qr_code" id="payment_method_qr_code" class="form-check-input">
                                <label class="form-check-label" for="payment_method_qr_code">QR Code</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" name="payment_method" value="cash_on_delivery" id="payment_method_cash_on_delivery" class="form-check-input">
                                <label class="form-check-label" for="payment_method_cash_on_delivery">Cash on Delivery</label>
                            </div>
                        </fieldset>
                        
                        <div id="qr-code-container" class="mb-4" style="display: none;">
                            {% for qr in qr_codes %}
                                <div class="qr-code mb-3">
                                    <h5>{{ qr.name }}</h5>
                                    <img src="{{ qr.image.url }}" alt="{{ qr.name }}" class="img-fluid" style="max-width: 200px; max-height: 200px;">
                                </div>
                            {% empty %}
                                <p>No QR codes available.</p>
                            {% endfor %}
                        </div>
                        
                        <div id="payment-receipt-container" class="mb-4" style="display: none;">
                            <label for="payment_receipt" class="form-label">Payment Receipt:</label>
                            <input type="file" name="payment_receipt" id="payment_receipt" class="form-control">
                        </div>
                        
                        <h4>Order Summary</h4>
                        <ul class="list-group mb-4">
                            {% for item in cart.items.all %}
                                <li class="list-group-item d-flex align-items-center">
                                    {% if item.content_object.images.exists %}
                                        <img src="{{ item.content_object.images.first.image.url }}" alt="{{ item.content_object.images.first.alt_text }}" class="img-thumbnail me-3" style="width: 100px; height: auto;">
                                    {% else %}
                                        <p>No image available</p>
                                    {% endif %}
                                    <div>
                                        <h5 class="mb-1">{{ item.content_object.name }}</h5>
                                        <p class="mb-0">Quantity: {{ item.quantity }}</p>
                                        <p class="mb-0">Price: ${{ item.get_price }}</p>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                        <p class="fw-bold">Total: ${{ cart.total_price }}</p>
                        
                        <button type="submit" class="btn btn-success">Place Order</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var qrCodeContainer = document.getElementById('qr-code-container');
        var paymentReceiptContainer = document.getElementById('payment-receipt-container');
        var paymentReceiptInput = document.getElementById('payment_receipt');
        var paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');

        function updateFormVisibility() {
            var selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked');
            if (selectedPaymentMethod) {
                if (selectedPaymentMethod.value === 'qr_code') {
                    qrCodeContainer.style.display = 'block';
                    paymentReceiptContainer.style.display = 'block';
                    paymentReceiptInput.setAttribute('required', 'required');
                } else {
                    qrCodeContainer.style.display = 'none';
                    paymentReceiptContainer.style.display = 'none';
                    paymentReceiptInput.removeAttribute('required');
                }
            }
        }

        paymentMethodRadios.forEach(function(radio) {
            radio.addEventListener('change', updateFormVisibility);
        });

        updateFormVisibility();
    });

    function initMap() {
        var phnomPenh = { lat: 11.5564, lng: 104.9282 };
        var map = new google.maps.Map(document.getElementById('map'), {
            center: phnomPenh,
            zoom: 12
        });

        var geocoder = new google.maps.Geocoder();
        var marker = new google.maps.Marker({
            map: map
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userLocation);
                    marker.setPosition(userLocation);
                    document.getElementById('latitude').value = userLocation.lat;
                    document.getElementById('longitude').value = userLocation.lng;

                    geocoder.geocode({ 'location': userLocation }, function(results, status) {
                        if (status === 'OK') {
                            if (results[0]) {
                                document.getElementById('address').value = results[0].formatted_address;
                            } else {
                                window.alert('No results found');
                            }
                        } else {
                            window.alert('Geocoder failed due to: ' + status);
                        }
                    });
                },
                function() {
                    handleLocationError(true, map, phnomPenh);
                }
            );
        } else {
            handleLocationError(false, map, phnomPenh);
        }

        map.addListener('click', function(event) {
            placeMarkerAndPanTo(event.latLng, map);
        });

        function placeMarkerAndPanTo(latLng, map) {
            marker.setPosition(latLng);
            map.panTo(latLng);
            document.getElementById('latitude').value = latLng.lat();
            document.getElementById('longitude').value = latLng.lng();

            geocoder.geocode({ 'location': latLng }, function(results, status) {
                if (status === 'OK') {
                    if (results[0]) {
                        document.getElementById('address').value = results[0].formatted_address;
                    } else {
                        window.alert('No results found');
                    }
                } else {
                    window.alert('Geocoder failed due to: ' + status);
                }
            });
        }

        function handleLocationError(browserHasGeolocation, map, fallbackLocation) {
            map.setCenter(fallbackLocation);
            marker.setPosition(fallbackLocation);
            document.getElementById('latitude').value = fallbackLocation.lat;
            document.getElementById('longitude').value = fallbackLocation.lng;
            document.getElementById('address').value = "Phnom Penh, Cambodia";
        }
    }

    function initAutocomplete() {
        var autocomplete = new google.maps.places.Autocomplete(
            document.getElementById('address'), 
            { types: ['geocode'] }
        );

        autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            document.getElementById('latitude').value = place.geometry.location.lat();
            document.getElementById('longitude').value = place.geometry.location.lng();
        });
    }

    google.maps.event.addDomListener(window, 'load', initAutocomplete);
</script>

<script
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap&v=weekly"
    defer
></script>
{% endblock %}
